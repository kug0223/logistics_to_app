# TO 그룹 관리 시스템 - Phase 2 & 3 완료 보고서

**작성일**: 2025-10-28  
**프로젝트**: 센터 관리 시스템 (Alfit)  
**완료 단계**: Phase 2 (TO 목록 개선) + Phase 3 (지원자 관리 개선)

---

## 📋 목차

1. [Phase 2: TO 목록 개선 완료](#phase-2-to-목록-개선-완료)
2. [Phase 3: 지원자 관리 개선 완료](#phase-3-지원자-관리-개선-완료)
3. [구현된 주요 기능](#구현된-주요-기능)
4. [UI/UX 개선사항](#uiux-개선사항)
5. [데이터 구조 변경](#데이터-구조-변경)
6. [다음 단계 (Phase 4)](#다음-단계-phase-4)

---

## ✅ Phase 2: TO 목록 개선 완료

### 2.1 이중 토글 UI 구현

**구조**:
```
그룹 카드 (1단계)
  └─ TO 카드 (2단계)
      └─ 업무 상세 (3단계)
```

**특징**:
- ✅ 그룹명 표시 및 날짜 범위 자동 계산
- ✅ 그룹 전체 통계 (확정/대기 인원)
- ✅ 개별 TO별 토글 가능
- ✅ 단일 TO도 토글로 업무 상세 보기

---

### 2.2 그룹 관리 기능

#### 2.2.1 그룹명 사용자 지정
- TO 생성 시 그룹명 직접 입력
- 기본값: "MM월 N주차 모음"
- 그룹명 수정 기능 (그룹 카드 헤더)

#### 2.2.2 그룹 삭제
- 그룹 전체 삭제 (모든 TO 함께 삭제)
- 확인 다이얼로그 포함
- 연관된 지원 데이터 함께 삭제

#### 2.2.3 그룹 해제
- 개별 TO를 그룹에서 분리
- 독립 TO로 전환
- 마지막 TO 자동 독립화

#### 2.2.4 그룹 재연결
**2가지 옵션**:
1. **기존 그룹에 연결**: 독립 TO를 기존 그룹에 추가
2. **새 그룹 생성**: 독립 TO로 새 그룹 생성 (대표 TO)

**제약사항**:
- 동일 사업장 TO만 그룹 연결 가능

---

### 2.3 TO 수정/삭제 기능

#### 2.3.1 TO 수정
- ✅ 단일 TO 수정
- ✅ 그룹 TO 개별 수정
- 제목, 설명, 지원 마감 수정 가능
- WorkDetails 수정 불가 (의도적 제한)

#### 2.3.2 TO 삭제 (4가지 케이스)

**Case 1: 단일 TO**
```
결과: TO 삭제 + 연관 데이터 삭제
```

**Case 2: 그룹 대표 TO (그룹 내 2개 이상)**
```
결과: TO 삭제 + 다음 TO가 대표로 승격
```

**Case 3: 그룹 일반 TO**
```
결과: TO만 삭제 + 그룹 날짜 범위 재계산
```

**Case 4: 그룹 마지막 TO**
```
결과: TO 삭제 + 남은 1개 TO가 독립 TO로 전환
```

---

### 2.4 업무 상세 표시 개선

#### 2.4.1 업무별 통계
- ✅ 업무 아이콘 + 유형명
- ✅ 근무 시간 (HH:mm ~ HH:mm)
- ✅ 급여 (원화 표시, 천 단위 콤마)
- ✅ 대기 인원 (주황색 배지)
- ✅ 확정 인원 (조건부 색상)

#### 2.4.2 조건부 색상 시스템
**확정 인원**:
- 🟢 **초록색**: 모집 완료 (확정 >= 필요)
- 🔵 **파란색**: 모집 중 (확정 < 필요)

**대기 인원**:
- 🟠 **주황색**: 항상 고정

**적용 위치**:
- TO 관리 화면 (그룹 카드, TO 카드, 업무 행)
- TO 상세 화면 (날짜 카드, 업무 카드)

---

## ✅ Phase 3: 지원자 관리 개선 완료

### 3.1 화면 구조 대대적 리팩토링

#### 3.1.1 탭 제거
**Before**:
```
[이 TO 탭] [그룹 전체 탭]
```

**After**:
```
날짜별 트리 구조 (탭 없음)
```

---

### 3.2 날짜별 트리 구조

#### 3.2.1 3단계 구조
```
▼ 날짜 (1단계)
  └─ TO명 (2단계)
      └─ 업무별 지원자 (3단계)
```

**예시**:
```
▼ 10/28 (화)  대기 2  확정 3  [📋 확정명단]
  └─ 분류작업
      ├─ 분류 (08:00~17:00, ₩ 53,000원)
      │  대기 2 | 확정 1 | [자세히]
      ├─ 피킹 (08:00~17:00, ₩ 55,000원)
      │  대기 0 | 확정 2 | [자세히]
      └─ 포장 (08:00~17:00, ₩ 50,000원)
         대기 0 | 확정 0 | [자세히]

▼ 10/29 (수)  대기 1  확정 4  [📋 확정명단] ⚠️ 2개 TO
  ├─ 분류작업2 (오전반)
  │   └─ 분류 (08:00~13:00, ₩ 50,000원)
  │      대기 1 | 확정 2 | [자세히]
  │
  └─ 분류작업3 (오후반)
      └─ 분류 (14:00~18:00, ₩ 60,000원)
         대기 2 | 확정 0 | [자세히]
```

---

### 3.3 날짜별 확정 명단 (NEW!)

#### 3.3.1 [📋 확정명단] 버튼
**위치**: 각 날짜 카드 헤더

**기능**:
- 해당 날짜의 확정된 지원자 목록
- 이름, 전화번호, 업무, 시간 표시
- 여러 TO가 있어도 한 화면에 통합 표시

**다이얼로그 구조**:
```
┌─────────────────────────────────────┐
│ 📋 10/28 (화) 확정 명단 (5명)        │
│                                     │
│ 👤 김철수                            │
│ 📱 010-1234-5678                    │
│ 💼 분류 (08:00~17:00)               │
│ 📋 분류작업                          │
│                                     │
│ 👤 이영희                            │
│ 📱 010-9876-5432                    │
│ 💼 피킹 (08:00~17:00)               │
│ 📋 분류작업                          │
│                                     │
│ [연락처 복사] [닫기]                 │
└─────────────────────────────────────┘
```

**예정 기능**:
- ⏳ 연락처 복사 (클립보드)
- ⏳ 엑셀 다운로드

---

### 3.4 업무별 지원자 모달 (NEW!)

#### 3.4.1 [자세히] 버튼
**위치**: 각 업무 카드

**기능**:
- 해당 업무의 모든 지원자 상세 정보
- 대기/확정/거절 상태별 분류
- 즉시 승인/거절 가능

**모달 구조**:
```
┌─────────────────────────────────────┐
│ 👥 분류 지원자 (5명)                 │
│                                     │
│ ⏰ 08:00~17:00  💰 ₩ 53,000원       │
│                                     │
│ ⏳ 대기 중 2명                       │
│ ┌─────────────────────────────────┐ │
│ │ 👤 김철수                        │ │
│ │ 📱 010-1234-5678                 │ │
│ │ 지원: 10/25 14:30                │ │
│ │ [거절] [승인]                    │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ✅ 확정 3명                          │
│ ┌─────────────────────────────────┐ │
│ │ 👤 이영희 (확정)                 │ │
│ │ 📱 010-9876-5432                 │ │
│ └─────────────────────────────────┘ │
│                                     │
│ [닫기]                               │
└─────────────────────────────────────┘
```

---

### 3.5 지원자 승인/거절

**프로세스**:
1. [자세히] 클릭 → 모달 열림
2. 대기 중인 지원자 확인
3. [승인] 또는 [거절] 클릭
4. 확인 다이얼로그
5. 즉시 반영 + 화면 새로고침

**특징**:
- ✅ 모달에서 바로 처리 가능
- ✅ 확인 다이얼로그로 실수 방지
- ✅ 로딩 인디케이터 표시
- ✅ 토스트 메시지로 결과 알림

---

## 🎨 UI/UX 개선사항

### 4.1 색상 시스템 통일

**조건부 색상 규칙**:
```dart
// 확정 인원
확정 >= 필요 → 🟢 초록색 (모집 완료)
확정 < 필요  → 🔵 파란색 (모집 중)

// 대기 인원
항상 → 🟠 주황색
```

**적용 화면**:
- ✅ TO 관리 화면 (3곳)
- ✅ TO 상세 화면 (2곳)

---

### 4.2 아이콘 시스템

**업무 아이콘**:
- 이모지 형태 (📦, 🚚, 🍔 등)
- 업무 유형과 함께 표시
- 한눈에 식별 가능

**상태 아이콘**:
- ✅ 확정
- ⏳ 대기
- ❌ 거절
- 📋 TO 정보
- 👤 지원자
- 📱 연락처
- 💼 업무
- ⏰ 시간
- 💰 급여

---

### 4.3 반응형 레이아웃

**카드 구조**:
- 그룹 카드: 회색 배경 + 모집 완료 시 초록 테두리
- TO 카드: 연한 회색 배경
- 업무 카드: 흰색 배경 + 연한 테두리

**여백 시스템**:
- 카드 간 여백: 12px
- 섹션 간 여백: 24px
- 내부 패딩: 12~16px

---

### 4.4 토글 인터랙션

**3단계 토글**:
1. 날짜 클릭 → TO 목록 표시/숨김
2. TO 클릭 → 업무 목록 표시/숨김
3. 업무는 자동 표시 (토글 없음)

**아이콘**:
- ▼ 펼쳐짐
- ▶ 접혀짐

---

## 💾 데이터 구조 변경

### 5.1 WorkDetailModel 확장

**추가 필드**:
```dart
class WorkDetailModel {
  // 기존 필드들...
  
  // ✅ NEW: 대기 중인 지원자 수 (런타임 계산)
  int pendingCount;
  
  WorkDetailModel({
    // ...
    this.pendingCount = 0,
  });
}
```

**용도**:
- TO 목록에서 업무별 대기 인원 표시
- Firestore에 저장하지 않음 (런타임에만 사용)

---

### 5.2 ApplicationModel 확인

**필드**:
```dart
class ApplicationModel {
  final String id;
  final String uid;
  final String toId;
  final String selectedWorkType;  // ✅ 업무 유형
  final int wage;
  final String status;  // PENDING, CONFIRMED, REJECTED
  final DateTime appliedAt;
  final DateTime? confirmedAt;
  final String? confirmedBy;
  // ...
}
```

**사용처**:
- 업무별 지원자 필터링
- 통계 계산

---

### 5.3 FirestoreService 추가 함수

#### 5.3.1 그룹 관리
```dart
// 그룹 삭제
Future<bool> deleteGroupTOs(String groupId)

// 그룹 해제
Future<bool> removeFromGroup(String toId)

// 그룹 재연결
Future<bool> reconnectToGroup({
  required String toId,
  required String targetGroupId,
})

// 새 그룹 생성
Future<bool> createNewGroupFromTO({
  required String toId,
  required String groupName,
})

// 그룹명 수정
Future<bool> updateGroupName(String groupId, String newGroupName)

// 그룹 날짜 범위 계산
Future<Map<String, DateTime>> calculateGroupTimeRange(String groupId)
```

#### 5.3.2 지원자 관리
```dart
// 업무별 지원자 조회
Future<List<ApplicationModel>> getApplicationsByWorkDetail(
  String toId,
  String workType,
)

// 그룹 전체 지원자 조회
Future<List<ApplicationModel>> getApplicationsByGroup(String groupId)

// 지원자 승인
Future<bool> confirmApplicant(String applicationId, String adminUID)

// 지원자 거절
Future<bool> rejectApplicant(String applicationId, String adminUID)
```

---

## 📁 파일 구조

### 6.1 수정된 파일

**화면 (Screens)**:
```
lib/screens/admin/
├── admin_to_list_screen.dart         (대대적 리팩토링)
├── admin_to_detail_screen.dart       (완전 재작성)
├── admin_create_to_screen.dart       (그룹명 입력 추가)
└── admin_edit_to_screen.dart         (기존 기능 유지)
```

**모델 (Models)**:
```
lib/models/
├── work_detail_model.dart            (pendingCount 추가)
├── application_model.dart            (기존 유지)
└── to_model.dart                     (기존 유지)
```

**서비스 (Services)**:
```
lib/services/
└── firestore_service.dart            (10개 함수 추가)
```

---

### 6.2 신규 클래스

**admin_to_list_screen.dart**:
```dart
class _TOGroupItem {
  final TOModel masterTO;
  final List<_TOItem> groupTOs;
  final bool isGrouped;
}

class _TOItem {
  final TOModel to;
  final List<WorkDetailModel> workDetails;
  final int confirmedCount;
  final int pendingCount;
}
```

**admin_to_detail_screen.dart**:
```dart
class _DateTOItem {
  final TOModel to;
  final List<_WorkDetailWithApplicants> workDetails;
}

class _WorkDetailWithApplicants {
  final WorkDetailModel workDetail;
  final List<Map<String, dynamic>> pendingApplicants;
  final List<Map<String, dynamic>> confirmedApplicants;
  final List<Map<String, dynamic>> rejectedApplicants;
}
```

---

## 🎯 구현된 주요 기능 요약

### Phase 2 완료 체크리스트

- [x] 이중 토글 UI (그룹 → TO → 업무)
- [x] 그룹명 사용자 지정
- [x] 그룹명 수정
- [x] 그룹 삭제 (전체)
- [x] 그룹 해제 (개별 TO)
- [x] 그룹 재연결 (기존 그룹 / 새 그룹)
- [x] TO 수정 (단일 / 그룹)
- [x] TO 삭제 (4가지 케이스)
- [x] 단일 TO 토글 지원
- [x] 업무별 통계 표시 (대기 + 확정)
- [x] 조건부 색상 시스템
- [x] 동일 사업장 필터링

### Phase 3 완료 체크리스트

- [x] 탭 제거 (통합 뷰)
- [x] 날짜별 트리 구조
- [x] 3단계 토글 (날짜 → TO → 업무)
- [x] [📋 확정명단] 기능
- [x] [자세히] 업무별 지원자 모달
- [x] 모달에서 승인/거절
- [x] 업무별 지원자 필터링
- [x] 날짜 중복 TO 표시 (⚠️ N개 TO)
- [x] 확정 명단 다이얼로그
- [x] 지원자 상세 정보 표시

---

## 🚀 다음 단계 (Phase 4)

### 4.1 연락처 관리 기능

#### 4.1.1 연락처 복사
- [ ] 확정 명단에서 전화번호 일괄 복사
- [ ] 클립보드 복사 기능
- [ ] 복사 완료 토스트

#### 4.1.2 엑셀 다운로드
- [ ] 확정 명단 엑셀 변환
- [ ] 날짜별 시트 생성
- [ ] 업무, 시간, 연락처 포함

---

### 4.2 지원자 상세 프로필

#### 4.2.1 프로필 화면
- [ ] 지원자 이름 클릭 시 프로필 열림
- [ ] 과거 근무 이력
- [ ] 출석률, 평가 점수
- [ ] 메모 기능

#### 4.2.2 통계
- [ ] 총 근무 일수
- [ ] 지각/결근 횟수
- [ ] 평균 평가 점수

---

### 4.3 일괄 처리 기능

#### 4.3.1 다중 선택
- [ ] 체크박스로 여러 지원자 선택
- [ ] 일괄 승인
- [ ] 일괄 거절

#### 4.3.2 필터링
- [ ] 상태별 필터 (대기/확정/거절)
- [ ] 업무별 필터
- [ ] 날짜 범위 필터

---

### 4.4 알림 시스템

#### 4.4.1 관리자 알림
- [ ] 새 지원자 알림
- [ ] 지원 마감 임박 알림
- [ ] 인원 미달 TO 알림

#### 4.4.2 지원자 알림
- [ ] 승인 알림 (푸시)
- [ ] 거절 알림 (푸시)
- [ ] TO 변경 알림

---

### 4.5 통계 및 리포트

#### 4.5.1 대시보드
- [ ] 전체 TO 현황
- [ ] 사업장별 통계
- [ ] 기간별 추이

#### 4.5.2 리포트
- [ ] 주간/월간 리포트 생성
- [ ] PDF 다운로드
- [ ] 이메일 전송

---

## 📊 성능 최적화

### 병렬 처리
- ✅ Future.wait()로 여러 쿼리 동시 실행
- ✅ TO별 통계 병렬 계산

### 캐싱
- ⏳ 사업장 정보 캐싱
- ⏳ 업무 유형 캐싱
- ⏳ 이미지 캐싱

---

## 🐛 알려진 이슈

### 해결됨
- ✅ WorkDetailModel pendingCount 추가
- ✅ ApplicationModel selectedWorkType 활용
- ✅ 색상 시스템 통일
- ✅ 조건부 색상 적용

### 진행 중
- ⏳ 연락처 복사 기능
- ⏳ 엑셀 다운로드

---

## 📝 참고사항

### 코드 컨벤션
- 함수명: camelCase
- 클래스명: PascalCase
- 상수: UPPER_SNAKE_CASE
- Private 함수: _로 시작

### 주석 규칙
```dart
// ✅ NEW: 새로 추가된 코드
// ⚠️ DEPRECATED: 곧 제거될 코드
// 🔧 FIX: 버그 수정
// 🎨 STYLE: UI 개선
```

---

## 🎉 완료 요약

**Phase 2 & 3 모두 완료!**

- ✅ 15개 주요 기능 구현
- ✅ 3개 화면 대대적 리팩토링
- ✅ 10개 FirestoreService 함수 추가
- ✅ 조건부 색상 시스템 구축
- ✅ 날짜별 트리 구조 완성

**다음 목표**: Phase 4 시작! 🚀

---

**작성자**: Claude (Anthropic)  
**검토자**: 개발자님  
**마지막 업데이트**: 2025-10-28
