# Phase 4: TO 마감/재오픈 기능 구현 완료 📋

> **작업 기간:** 2025년 1월  
> **작업자:** Claude & 개발자  
> **프로젝트:** 센터 관리 앱 - TO 관리 시스템

---

## 📚 목차

1. [Phase 4 개요](#phase-4-개요)
2. [구현된 기능](#구현된-기능)
3. [파일별 수정 내역](#파일별-수정-내역)
4. [데이터 모델 변경](#데이터-모델-변경)
5. [UI/UX 개선사항](#uiux-개선사항)
6. [테스트 데이터 생성 도구](#테스트-데이터-생성-도구)
7. [주요 이슈 및 해결방법](#주요-이슈-및-해결방법)
8. [다음 단계](#다음-단계)

---

## Phase 4 개요

### 목표
관리자가 TO(인력 공고)를 **수동으로 마감/재오픈**할 수 있는 기능 추가 및 **진행중/마감됨 탭**으로 TO 상태 관리 개선

### 주요 기능
- ✅ 진행중/마감됨 탭으로 TO 분류
- ✅ 수동 마감/재오픈 기능
- ✅ 자동 마감 로직 (시간 초과, 인원 충족)
- ✅ 그룹 TO 일괄 마감/재오픈
- ✅ 마감 사유 배지 표시
- ✅ 시간 초과 TO 재오픈 방지
- ✅ UI 색상 및 디자인 개선

---

## 구현된 기능

### 1. TO 상태 관리

#### 진행중 탭
- 수동 마감되지 않은 TO
- 시간이 지나지 않은 TO
- 인원이 충족되지 않은 TO

#### 마감됨 탭
- **수동 마감:** 관리자가 직접 마감한 TO
- **자동 마감 (시간 초과):** 근무 시작 시간이 지난 TO
- **자동 마감 (인원 충족):** 필요 인원이 모두 확정된 TO

### 2. 마감/재오픈 버튼

#### 단일 TO
- TO 카드의 더보기(⋮) 메뉴에서 "TO 마감" / "TO 재오픈" 선택
- 마감 시 확인 다이얼로그 표시
- 재오픈 시 시간 초과 체크

#### 그룹 TO
- 그룹 카드의 더보기 메뉴에서 "그룹 마감" / "그룹 재오픈" 선택
- 그룹 내 모든 TO 일괄 처리
- 시간 초과된 TO가 있으면 재오픈 불가

### 3. 마감 배지

TO 카드 헤더에 마감 사유 배지 표시:
- 🔒 **수동 마감** (주황색)
- ⏰ **시간 초과** (회색)
- ✅ **인원 충족** (초록색)

### 4. 시간 초과 TO 재오픈 방지

근무 시작 시간이 지난 TO는 재오픈 불가:
- 재오픈 시도 시 오류 다이얼로그 표시
- 근무일, 시간 정보 표시
- "새로운 날짜로 TO 생성" 안내

---

## 파일별 수정 내역

### 📁 models/to_model.dart

**추가된 필드:**
```dart
bool isManualClosed;       // 수동 마감 여부
DateTime? closedAt;        // 마감 시각
String? closedBy;          // 마감한 관리자 UID
DateTime? reopenedAt;      // 재오픈 시각
String? reopenedBy;        // 재오픈한 관리자 UID
```

**추가된 계산 속성:**
```dart
bool get isTimeExpired     // 시간 초과 여부
bool get isFull            // 인원 충족 여부
bool get isClosed          // 마감 여부 (수동 || 시간 || 인원)
String get closedReason    // 마감 사유 텍스트
int get closedReasonColor  // 마감 사유 색상
```

### 📁 services/firestore_service.dart

**추가된 함수:**

1. **getActiveTOs()** - 진행중 TO 조회
   ```dart
   Future<List<TOModel>> getActiveTOs()
   ```
   - 대표 TO + 단일 TO 조회
   - 마감되지 않은 TO만 필터링

2. **getClosedTOs()** - 마감된 TO 조회
   ```dart
   Future<List<TOModel>> getClosedTOs()
   ```
   - 수동 마감 + 자동 마감 TO 조회
   - 최근 마감 순으로 정렬

3. **closeTOManually()** - 단일 TO 수동 마감
   ```dart
   Future<bool> closeTOManually(String toId, String adminUID)
   ```

4. **reopenTO()** - 단일 TO 재오픈
   ```dart
   Future<bool> reopenTO(String toId, String adminUID)
   ```

5. **closeGroupTOs()** - 그룹 TO 일괄 마감
   ```dart
   Future<bool> closeGroupTOs(String groupId, String adminUID)
   ```

6. **reopenGroupTOs()** - 그룹 TO 일괄 재오픈
   ```dart
   Future<bool> reopenGroupTOs(String groupId, String adminUID)
   ```

### 📁 screens/admin/admin_to_list_screen.dart

**주요 변경사항:**

1. **탭 UI 추가**
   ```dart
   String _selectedTab = 'ACTIVE';  // 'ACTIVE' or 'CLOSED'
   Widget _buildTabs()              // 탭 UI 위젯
   ```

2. **마감 배지 추가**
   - 그룹 카드 헤더에 마감 사유 배지 표시

3. **마감/재오픈 버튼 추가**
   - 단일 TO: PopupMenu에 메뉴 추가
   - 그룹 TO: PopupMenu에 메뉴 추가

4. **다이얼로그 함수 추가**
   ```dart
   _showCloseTODialog()        // 단일 TO 마감
   _showReopenTODialog()       // 단일 TO 재오픈
   _showCloseGroupDialog()     // 그룹 마감
   _showReopenGroupDialog()    // 그룹 재오픈
   ```

5. **Import 추가**
   ```dart
   import 'package:provider/provider.dart';
   import '../../providers/user_provider.dart';
   ```

---

## 데이터 모델 변경

### Firestore 스키마 변경

#### TO 문서 (tos 컬렉션)

**추가된 필드:**
```javascript
{
  // 기존 필드...
  
  // Phase 4 추가 필드
  "isManualClosed": false,           // boolean
  "closedAt": Timestamp,             // nullable
  "closedBy": "admin_uid",           // nullable
  "reopenedAt": Timestamp,           // nullable
  "reopenedBy": "admin_uid"          // nullable
}
```

### 필드 기본값

**새로 생성되는 TO:**
- `isManualClosed: false` 자동 설정

**기존 TO (Phase 4 이전):**
- 필드 없음 → `TOModel.fromMap`에서 `false`로 처리

---

## UI/UX 개선사항

### 1. 탭 디자인 개선

**Before:**
- 단순한 회색 배경 탭
- 색상 대비 약함

**After:**
- 활성 탭: 진한 파란색 (`#1E88E5`) + 그림자 효과
- 비활성 탭: 투명 배경 + 진한 회색 텍스트 (`#757575`)
- 둥근 모서리 (`borderRadius: 10`)
- Material Design 3 스타일

### 2. 빈 화면 개선

**Before:**
- 회색 아이콘 + 회색 텍스트
- 심심한 느낌

**After:**
- 파란색 아이콘 (`Colors.blue[200]`)
- 연한 파란색 배경 박스 (`Colors.blue[50]`)
- 둥근 모서리 (`borderRadius: 20`)

### 3. 색상 팔레트

```dart
// Primary Colors
주요 파란색: #1E88E5
배경 파란색: #E3F2FD

// Status Colors
수동 마감: #FF9800 (주황)
시간 초과: #9E9E9E (회색)
인원 충족: #4CAF50 (초록)
오류/거절: #F44336 (빨강)

// Text Colors
텍스트 진함: #212121
텍스트 보통: #757575
배경: #FAFAFA
```

---

## 테스트 데이터 생성 도구

### 📁 utils/test_data_helper.dart

**기능:**
1. **더미 지원자 생성**
   - 랜덤 이름, 전화번호, 이메일 생성
   - `isDummy: true` 플래그로 표시

2. **더미 지원서 생성**
   - 특정 TO에 대기/확정 지원서 생성
   - 랜덤 업무 유형 배정

3. **더미 데이터 삭제**
   - `isDummy: true`인 모든 데이터 일괄 삭제

### 사용 방법

**관리자 화면에서:**
1. 🧪 아이콘 클릭
2. "더미 데이터 생성" 선택
3. TO 선택
4. 대기/확정 인원 입력 (예: 대기 3명, 확정 2명)
5. 생성 완료!

**삭제:**
1. 🧪 아이콘 클릭
2. "더미 데이터 삭제" 선택
3. 확인

---

## 주요 이슈 및 해결방법

### 이슈 1: 기존 TO 조회 안 됨

**원인:**
- Firestore 쿼리에서 `where('isManualClosed', isEqualTo: false)` 사용
- 기존 TO에는 `isManualClosed` 필드가 없어서 조회 실패

**해결:**
```dart
// Before (문제)
.where('isManualClosed', isEqualTo: false)

// After (해결)
// 조건 제거하고 클라이언트에서 필터링
final allTOs = snapshot.docs.map(...).toList();
final activeTOs = allTOs.where((to) => !to.isClosed).toList();
```

### 이슈 2: 단일 TO가 목록에 안 보임

**원인:**
- `where('isGroupMaster', isEqualTo: true)` 조건
- 단일 TO는 `isGroupMaster: false`

**해결:**
```dart
// 모든 TO 조회 후 클라이언트에서 필터링
final masterOrSingleTOs = allTOs.where((to) {
  if (to.groupId != null) {
    return to.isGroupMaster;  // 그룹 TO면 대표만
  }
  return true;  // 단일 TO는 모두
}).toList();
```

### 이슈 3: Firestore 인덱스 필요

**원인:**
- 복합 쿼리 사용 (`where + orderBy`)
- Firestore 인덱스 필요

**해결:**
```
옵션 1: 에러 메시지의 링크 클릭 → 자동 인덱스 생성
옵션 2: Firebase Console에서 수동 생성
  - 컬렉션: tos
  - 필드: isManualClosed (오름차순), closedAt (내림차순)
옵션 3: orderBy 제거하고 클라이언트에서 정렬
```

### 이슈 4: 시간 초과 TO 재오픈 문제

**원인:**
- 시간 초과된 TO를 재오픈해도 `isTimeExpired`가 여전히 `true`
- `to.isClosed`가 계속 `true`로 계산됨

**해결:**
```dart
// 재오픈 시 시간 초과 체크
if (to.isTimeExpired) {
  // 오류 다이얼로그 표시
  // 재오픈 불가 안내
  return;
}
```

### 이슈 5: 그룹 마감 후 마감됨 탭에 안 보임

**원인:**
- 인덱스 문제 또는 필터링 로직 문제

**해결:**
- 디버깅 로그 추가
- 쿼리 단순화
- 인덱스 생성

---

## 다음 단계

### Phase 5 옵션

**우선순위 높음:**

1. **연락처 관리 기능** (2-3시간) ⭐⭐⭐
   - 확정 명단 연락처 복사
   - 엑셀 다운로드 (날짜별 시트)
   - 실용성 최고

2. **일괄 처리 기능** (3-4시간) ⭐⭐
   - 체크박스로 다중 선택
   - 일괄 승인/거절
   - 상태별/업무별 필터

**우선순위 중간:**

3. **지원자 상세 프로필** (4-5시간) ⭐
   - 과거 근무 이력
   - 출석률, 평가 점수
   - 관리자 메모 기능

4. **알림 시스템** (5-6시간) ⭐
   - 새 지원자 알림
   - 지원 마감 임박 알림
   - FCM 설정 필요

**우선순위 낮음:**

5. **통계 대시보드** (6-8시간)
   - 전체 TO 현황
   - 사업장별 통계
   - 데이터 축적 후 의미있음

---

## 체크리스트

### Phase 4 완료 확인

- [x] TO 모델 확장 (`isManualClosed`, `closedAt` 등)
- [x] 계산 속성 추가 (`isTimeExpired`, `isFull`, `isClosed`)
- [x] FirestoreService 함수 구현
  - [x] `getActiveTOs()`
  - [x] `getClosedTOs()`
  - [x] `closeTOManually()`
  - [x] `reopenTO()`
  - [x] `closeGroupTOs()`
  - [x] `reopenGroupTOs()`
- [x] UI 개선
  - [x] 진행중/마감됨 탭 추가
  - [x] 탭 디자인 개선
  - [x] 빈 화면 개선
- [x] 마감/재오픈 버튼
  - [x] 단일 TO 버튼
  - [x] 그룹 TO 메뉴
  - [x] 마감 배지 표시
- [x] 시간 초과 TO 재오픈 방지
- [x] 다이얼로그 구현
  - [x] 마감 확인
  - [x] 재오픈 확인
  - [x] 시간 초과 오류
- [x] 테스트 데이터 생성 도구
- [x] 기존 TO 조회 이슈 해결
- [x] 단일 TO 표시 이슈 해결
- [x] Firestore 인덱스 생성

### 테스트 항목

- [ ] 단일 TO 마감/재오픈
- [ ] 그룹 TO 마감/재오픈
- [ ] 시간 초과 TO 재오픈 방지
- [ ] 인원 충족 TO 표시
- [ ] 탭 전환 동작
- [ ] 마감 배지 표시
- [ ] 더미 데이터 생성/삭제

---

## 참고 자료

### 관련 파일
```
lib/
├── models/
│   └── to_model.dart                    // TO 모델 (필드 추가)
├── services/
│   └── firestore_service.dart           // Firebase 서비스 (함수 추가)
├── screens/
│   └── admin/
│       └── admin_to_list_screen.dart    // TO 목록 화면 (UI 개선)
├── providers/
│   └── user_provider.dart               // 사용자 정보 (기존)
└── utils/
    └── test_data_helper.dart            // 테스트 데이터 생성 (신규)
```

### 주요 개념

**TO 상태:**
- 진행중: `!to.isClosed`
- 마감됨: `to.isClosed` (수동 || 시간 초과 || 인원 충족)

**마감 우선순위:**
1. 수동 마감 (`isManualClosed: true`)
2. 시간 초과 (`isTimeExpired: true`)
3. 인원 충족 (`isFull: true`)

**재오픈 조건:**
- 시간이 지나지 않은 TO만 재오픈 가능
- 그룹 TO는 모든 TO가 시간 안 지났을 때만 가능

---

## 작업 시간 기록

| 작업 | 예상 시간 | 실제 시간 |
|------|----------|----------|
| TO 모델 확장 | 30분 | 30분 |
| FirestoreService 함수 | 1시간 | 1.5시간 |
| UI 탭 추가 | 30분 | 45분 |
| 마감/재오픈 버튼 | 1시간 | 1.5시간 |
| 다이얼로그 구현 | 1시간 | 1시간 |
| 디자인 개선 | 30분 | 45분 |
| 이슈 해결 | - | 2시간 |
| 테스트 데이터 도구 | 1시간 | 1시간 |
| **합계** | **5.5시간** | **8.5시간** |

---

## 마무리

Phase 4에서 구현한 TO 마감/재오픈 기능은 관리자가 공고 상태를 유연하게 관리할 수 있게 해줍니다. 진행중/마감됨 탭으로 분류하고, 수동/자동 마감을 구분하며, 시간 초과된 공고의 재오픈을 방지하여 데이터 정합성을 유지합니다.

이제 Phase 5로 넘어가 연락처 관리, 일괄 처리 등 추가 기능을 구현할 준비가 되었습니다! 🚀

---

**문서 버전:** 1.0  
**최종 수정일:** 2025-01-XX  
**작성자:** Claude & 개발자
