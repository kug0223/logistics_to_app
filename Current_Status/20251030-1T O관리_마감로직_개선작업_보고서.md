# TO 관리 시스템 - 마감 로직 개선 작업 보고서

**작성일:** 2025-10-30  
**작업자:** 개발팀  
**상태:** 🟡 진행중 (추가 작업 필요)

---

## 📋 목차
1. [오늘 완료한 작업](#오늘-완료한-작업)
2. [발견된 주요 문제점](#발견된-주요-문제점)
3. [해결 완료 항목](#해결-완료-항목)
4. [미해결 이슈](#미해결-이슈)
5. [내일 작업 계획](#내일-작업-계획)
6. [기술적 세부사항](#기술적-세부사항)

---

## 🎯 오늘 완료한 작업

### 1. 업무 상세 인원 표시 오류 수정 ✅
**문제:** TO 목록 화면에서 업무 상세 카드 펼칠 때 "0/5명" 표시  
**원인:** `work.currentCount` (Firestore 필드) 사용했는데 실제 데이터와 불일치  
**해결:**
- `_loadTOsWithStats()` 함수에서 실제 지원서 조회로 통계 계산
- `workDetailStats` 맵으로 캐싱하여 성능 개선
- 단일 TO + 그룹 TO 모두 적용

**수정 파일:**
- `lib/screens/admin/admin_to_list_screen.dart` (132줄, 90줄)
- `_TOItem` 클래스에 `workDetailStats` 필드 추가

---

### 2. 정원 초과 확정 방지 ✅
**문제:** 필요 인원(2명)보다 많이 확정(3명) 가능  
**원인:** `confirmApplicantWithWorkDetail()` 함수에 정원 체크 없음  
**해결:**
- WorkDetail의 `currentCount`와 `requiredCount` 비교 로직 추가
- 정원 초과 시 토스트 메시지 표시: "이미 정원이 충족되었습니다. (3/2명)"

**수정 파일:**
- `lib/services/firestore_service.dart` - `confirmApplicantWithWorkDetail()` 함수 (670줄 근처)

---

### 3. 더미 데이터 카운트 문제 수정 ✅
**문제:** 더미 데이터(`isDummy=true`)가 통계에서 제외돼서 0으로 표시  
**원인:** `_recalculateStatsAfterConfirm/Reject` 함수에서 `!isDummy` 체크  
**해결:**
- 통계 계산 시 `isDummy` 체크 완전 제거
- 더미/실제 데이터 구분 없이 모두 카운트

**수정 파일:**
- `lib/services/firestore_service.dart` - `_recalculateStatsAfterConfirm()`, `_recalculateStatsAfterReject()`

---

### 4. 확정 후 목록 화면 자동 새로고침 ✅
**문제:** 지원자 확정 후 뒤로가기 눌러도 TO 목록 화면이 업데이트 안 됨  
**해결:**
- `admin_to_detail_screen.dart`에서 `_hasChanges` 플래그 추가
- 확정/거절 시 `_hasChanges = true` 설정
- AppBar 뒤로가기 버튼 오버라이드하여 `Navigator.pop(context, _hasChanges)` 반환
- `admin_to_list_screen.dart`에서 `result == true` 감지 시 `_loadTOsWithStats()` 호출

**수정 파일:**
- `lib/screens/admin/admin_to_detail_screen.dart` (70줄, 267줄, 319줄, 384줄)
- `lib/screens/admin/admin_to_list_screen.dart` (1339줄, 1523줄)

---

### 5. 아이콘 텍스트 표시 오류 수정 ✅
**문제:** "material.58278 배송" - 아이콘이 텍스트로 표시  
**해결:**
- `WorkTypeIcon.buildFromString()` 사용
- `import '../../widgets/work_type_icon.dart'` 추가

**수정 파일:**
- `lib/screens/admin/admin_to_detail_screen.dart` (740줄 근처)

---

### 6. 그룹 TO 날짜/시간 표시 오류 수정 ✅
**문제:** 그룹 TO의 두 번째 날짜로 들어가면 날짜/시간이 "10/31 ~ 10/30", "--:-- ~ --:--" 표시  
**원인:** `widget.to`가 항상 첫 번째 TO 정보만 가짐  
**해결:**
- `_buildHeader()` 함수에서 실제 날짜 범위 계산
- `_dateGroupedData` 전체를 순회하여 최소/최대 날짜와 시간 추출

**수정 파일:**
- `lib/screens/admin/admin_to_detail_screen.dart` - `_buildHeader()` 함수

---

### 7. TO 수정 시 마감 상태 초기화 추가 ✅
**문제:** TO 시간 수정해도 여전히 "마감됨" 상태  
**해결:**
- `_saveChanges()` 함수에서 `closedAt`, `closedBy`, `isManualClosed` 초기화
- `reopenedAt`, `reopenedBy` 기록

**수정 파일:**
- `lib/screens/admin/admin_edit_to_screen.dart` - `_saveChanges()` 함수

```dart
updates['closedAt'] = FieldValue.delete();
updates['closedBy'] = FieldValue.delete();
updates['isManualClosed'] = false;
updates['reopenedAt'] = Timestamp.now();
updates['reopenedBy'] = userProvider.currentUser?.uid;
```

---

## 🔴 발견된 주요 문제점

### 1. 그룹 TO 시간 초과 판정 문제 ⚠️
**현상:**
- 그룹 TO 중 일부 날짜만 시간 초과되면 전체 그룹이 "마감됨" 탭으로 이동
- 예: 10/30 (18:00 시작, 시간 초과) + 10/31 (18:00 시작, 진행중)
- → 전체 그룹이 마감됨으로 분류

**원인:**
```dart
bool get isTimeExpired {
  // 대표 TO의 startTime만 체크
  // 각 날짜별 개별 시간을 체크하지 않음
}
```

**영향:**
- 그룹 TO의 경우 부정확한 마감 판정
- 진행중인 날짜가 있어도 마감됨으로 표시

---

### 2. 대표 TO 시간 정보의 의미 모호성 ⚠️
**문제:**
- 그룹 대표 TO의 `startTime`, `endTime` 필드가 의미 없음
- 각 날짜별로 다른 시작/종료 시간을 가질 수 있음
- `displayStartTime` (그룹 최소 시작 시간)과 실제 각 날짜의 시작 시간이 다름

**예시:**
```
그룹 대표 TO: startTime = 18:00 (10/30 기준)
실제 10/30 TO: WorkDetail에 19:00 시작
실제 10/31 TO: WorkDetail에 18:00 시작
```

---

### 3. 마감 로직 복잡도 증가 ⚠️
**3가지 마감 판정 기준:**
```dart
bool get isClosed {
  return isManualClosed    // 수동 마감
      || isTimeExpired     // 시간 초과
      || isFull;           // 인원 충족
}
```

**각 기준별 문제:**
- `isManualClosed`: Firebase 필드 기반 (OK)
- `isTimeExpired`: 그룹 TO 처리 불완전
- `isFull`: 단순 비교 (OK)

---

### 4. 지원 마감 vs 근무 시작 시간 혼동 ⚠️
**현재 상황:**
- `applicationDeadline` (지원 마감 시간) - 사용자가 지원 가능한 마지막 시간
- `startTime` (근무 시작 시간) - 실제 일을 시작하는 시간
- **`isTimeExpired`는 `startTime`만 체크** - `applicationDeadline`은 무시

**의문점:**
- 지원 마감 시간 지나면 어떻게 처리해야 하나?
- 근무 시작 전인데 지원만 마감된 경우는?

---

## ✅ 해결 완료 항목

| 번호 | 문제 | 상태 | 완료일 |
|------|------|------|--------|
| 1 | 업무 상세 인원 0/5명 표시 | ✅ 완료 | 10/30 |
| 2 | 정원 초과 확정 가능 | ✅ 완료 | 10/30 |
| 3 | 더미 데이터 카운트 안 됨 | ✅ 완료 | 10/30 |
| 4 | 확정 후 목록 새로고침 안 됨 | ✅ 완료 | 10/30 |
| 5 | 아이콘 텍스트로 표시 | ✅ 완료 | 10/30 |
| 6 | 그룹 TO 날짜/시간 표시 오류 | ✅ 완료 | 10/30 |
| 7 | TO 수정 시 마감 상태 초기화 | ✅ 완료 | 10/30 |

---

## ⏳ 미해결 이슈

### 🔴 Critical (필수 해결)

#### 1. 그룹 TO 시간 초과 판정 재설계
**파일:** `lib/models/to_model.dart`  
**함수:** `bool get isTimeExpired`

**현재 문제:**
- 대표 TO의 시간만 체크
- 각 날짜별 개별 시간 미반영

**해결 방안:**
```dart
bool get isTimeExpired {
  // 그룹 TO인 경우: endDate 기준으로만 판단
  if (isGrouped && endDate != null) {
    final today = DateTime.now();
    final groupEndDate = DateTime(endDate!.year, endDate!.month, endDate!.day);
    return groupEndDate.isBefore(
      DateTime(today.year, today.month, today.day)
    );
  }
  
  // 단일 TO인 경우: 기존 로직 유지
  // ...
}
```

---

#### 2. getActiveTOs() 함수 개선
**파일:** `lib/services/firestore_service.dart`  
**함수:** `Future<List<TOModel>> getActiveTOs()`

**현재 문제:**
- 그룹 TO의 개별 날짜별 시간 체크 안 함
- 대표 TO만 체크하여 부정확한 분류

**해결 방안:**
```dart
Future<List<TOModel>> getActiveTOs() async {
  // 1. 모든 TO 조회
  // 2. 그룹 TO인 경우:
  //    - 같은 그룹의 모든 TO 조회
  //    - 하나라도 진행중이면 포함
  // 3. 단일 TO인 경우:
  //    - isTimeExpired 체크
}
```

**추가 로그 필요:**
```dart
print('🔍 [그룹체크] ${masterTO.groupName}');
print('   그룹 내 TO 개수: ${groupTOs.length}개');
for (var to in groupTOs) {
  print('   - ${to.date}: expired=${_isTimeExpired(to)}');
}
```

---

### 🟡 Medium (중요하지만 긴급하지 않음)

#### 3. 지원 마감 시간 처리 정책 결정
**질문:**
1. `applicationDeadline` 지나면 어떻게 처리?
   - A안: 여전히 "진행중" (근무 전이니까)
   - B안: "지원 마감" 상태 추가
   
2. 근무 시작 전 + 지원 마감 후 상태는?
   - 별도 표시 필요?

**관련 코드:**
- `TOModel.isTimeExpired` getter
- TO 목록 화면 탭 분류 로직

---

#### 4. 대표 TO 시간 필드 재정의
**문제:**
- 그룹 TO의 `startTime`, `endTime` 의미 모호
- `displayStartTime`, `displayEndTime` (그룹 전체 범위) vs 각 날짜 개별 시간

**고려사항:**
- 기존 데이터 마이그레이션 필요 여부
- UI 표시 로직 영향도

---

### 🟢 Low (개선 사항)

#### 5. 마감 로직 통합 테스트
**현재 상황:**
- 개별 기능은 작동
- 통합 시나리오 미검증

**테스트 시나리오:**
1. 그룹 TO 생성 → 일부 날짜 시간 초과 → 탭 이동 확인
2. TO 수정 → 시간 변경 → 마감 상태 변화 확인
3. 정원 충족 → 자동 마감 → 재오픈 테스트
4. 수동 마감 → TO 수정 → 자동 재오픈 확인

---

#### 6. 코드 정리
**대상:**
- 디버그 로그 정리/제거
- 중복 코드 제거
- 주석 정리

**파일:**
- `admin_to_list_screen.dart` (print 로그 다수)
- `firestore_service.dart` (print 로그 다수)
- `to_model.dart` (print 로그 다수)

---

## 📅 내일 작업 계획

### Phase 1: 그룹 TO 마감 로직 재설계 (우선순위: 🔴 High)
**예상 소요 시간:** 2-3시간

1. **`TOModel.isTimeExpired` getter 수정**
   - 그룹 TO: `endDate` 기준 판정
   - 단일 TO: 기존 로직 유지
   - 테스트 케이스 작성

2. **`FirestoreService.getActiveTOs()` 개선**
   - 그룹 TO 전체 날짜 체크
   - 로그 추가하여 디버깅 용이하게

3. **통합 테스트**
   - 그룹 TO 생성 (10/30 + 10/31)
   - 10/30 시간 초과 시 → 여전히 진행중 탭에 있는지 확인
   - 10/31도 시간 초과 시 → 마감됨 탭으로 이동 확인

---

### Phase 2: 지원 마감 정책 결정 (우선순위: 🟡 Medium)
**예상 소요 시간:** 1시간

1. **요구사항 명확화**
   - 지원 마감 시간의 의미
   - UI 표시 방법
   - 탭 분류 기준

2. **코드 수정 범위 파악**
   - `isTimeExpired` vs 새 getter 추가
   - TO 목록 화면 수정 필요 여부

---

### Phase 3: 코드 정리 및 문서화 (우선순위: 🟢 Low)
**예상 소요 시간:** 1시간

1. **디버그 로그 정리**
   - 배포용 로그만 남기기
   - 개발용 로그 제거 또는 주석 처리

2. **주석 추가**
   - 복잡한 로직에 설명 추가
   - 마감 판정 기준 명시

---

## 🔧 기술적 세부사항

### 파일 구조

```
lib/
├── models/
│   ├── to_model.dart
│   │   └── isTimeExpired getter 수정 필요 ⚠️
│   ├── application_model.dart
│   └── work_detail_model.dart
│
├── screens/admin/
│   ├── admin_to_list_screen.dart
│   │   ├── _loadTOsWithStats() - 통계 캐싱 ✅
│   │   └── result 받아서 새로고침 ✅
│   ├── admin_to_detail_screen.dart
│   │   ├── _hasChanges 플래그 ✅
│   │   └── 아이콘 표시 수정 ✅
│   └── admin_edit_to_screen.dart
│       └── _saveChanges() - 마감 상태 초기화 ✅
│
└── services/
    └── firestore_service.dart
        ├── confirmApplicantWithWorkDetail() - 정원 체크 ✅
        ├── _recalculateStatsAfterConfirm() - 더미 포함 ✅
        ├── _recalculateStatsAfterReject() - 더미 포함 ✅
        └── getActiveTOs() - 개선 필요 ⚠️
```

---

### 데이터 흐름

```
TO 목록 로드
    ↓
getActiveTOs() / getClosedTOs()
    ↓ (각 TO별)
masterTO.isClosed 체크
    ↓
isManualClosed || isTimeExpired || isFull
    ↓
[문제] isTimeExpired가 그룹 TO 처리 불완전
```

---

### 마감 판정 로직 (현재)

```dart
// TOModel
bool get isClosed => isManualClosed || isTimeExpired || isFull;

bool get isTimeExpired {
  // 1. 근무일이 과거 → true
  // 2. 근무일이 오늘 + startTime 지남 → true
  // 3. 근무일이 미래 → false
  
  // ⚠️ 문제: 그룹 TO는 날짜별로 다른 시간
}
```

---

### 마감 판정 로직 (개선안)

```dart
bool get isTimeExpired {
  // 🔥 그룹 TO: endDate 기준
  if (isGrouped && endDate != null) {
    return DateTime.now().isAfter(endDate!);
  }
  
  // 단일 TO: 기존 로직
  // 근무일 + startTime 체크
}
```

---

## 📝 참고사항

### 테스트 시 주의사항
1. **더미 데이터 사용**
   - `isDummy=true` 플래그 활용
   - 실제 사용자 영향 없이 테스트

2. **시간 테스트**
   - 시간 변경 시 앱 재시작 필요
   - Firestore 캐시 고려

3. **그룹 TO 테스트**
   - 최소 2개 날짜로 테스트
   - 각 날짜별 다른 시작 시간 설정

---

### 알려진 제약사항
1. **Firestore `FieldValue.delete()`**
   - 웹에서는 인스턴스 표시만 (`FieldValue(Instance of 'FieldValueWeb')`)
   - 실제로는 정상 작동

2. **캐시 유효 시간**
   - `_cacheValidDuration = 5분`
   - 통계 불일치 발생 가능

3. **그룹 TO 대표 선정**
   - 첫 번째 날짜 TO가 대표
   - `isGroupMaster = true`

---

## 🎯 최종 목표

### 단기 목표 (내일)
- ✅ 그룹 TO 시간 초과 판정 정상화
- ✅ TO 수정 시 자동 재오픈 완벽 작동
- ✅ 진행중/마감됨 탭 정확한 분류

### 중기 목표 (이번 주)
- 지원 마감 시간 정책 확정
- 전체 마감 로직 통합 테스트
- 코드 정리 및 문서화

### 장기 목표
- 마감 로직 리팩토링 (필요 시)
- 성능 최적화
- 사용자 피드백 반영

---

## 💬 커뮤니케이션

### 질문 사항
1. 지원 마감 시간 지나면 어떻게 처리할지?
2. 그룹 TO 대표 시간 필드를 없앨지, 아니면 의미를 재정의할지?

### 다음 회의 안건
- 마감 정책 최종 결정
- UI/UX 개선 방향

---

**작성자:** AI Assistant  
**최종 수정:** 2025-10-30 19:00  
**버전:** 1.0
